# action.yml

# ███╗   ███╗███████╗████████╗████████╗██╗     ███████╗ ██████╗██╗
# ████╗ ████║██╔════╝╚══██╔══╝╚══██╔══╝██║     ██╔════╝██╔════╝██║
# ██╔████╔██║█████╗     ██║      ██║   ██║     █████╗  ██║     ██║
# ██║╚██╔╝██║██╔══╝     ██║      ██║   ██║     ██╔══╝  ██║     ██║
# ██║ ╚═╝ ██║███████╗   ██║      ██║   ███████╗███████╗╚██████╗██║
# ╚═╝     ╚═╝╚══════╝   ╚═╝      ╚═╝   ╚══════╝╚══════╝ ╚═════╝╚═╝
# MettleCI DevOps for DataStage       (C) 2025-2026 Data Migrators
#                                      _ _
#   ___ ___  _ __ ___  _ __   ___  ___(_) |_ ___
#  / __/ _ \| '_ ` _ \| '_ \ / _ \/ __| | __/ _ \
# | (_| (_) | | | | | | |_) | (_) \__ \ | ||  __/
#  \___\___/|_| |_| |_| .__/ \___/|___/_|\__\___|
#      _            _ |_|
#   __| | ___ _ __ | | ___  _   _
#  / _` |/ _ \ '_ \| |/ _ \| | | |
# | (_| |  __/ |_) | | (_) | |_| |
#  \__,_|\___| .__/|_|\___/ \__, |
#            |_|            |___/

name: "MCIX deploy (overlay, import, compile)"
description: "Applies overlays to DataStage assets, then imports and compiles them"
author: "Data Migrators Pty Ltd"
branding:
  icon: "layers"
  color: "blue"

# Note that true/false boolean inputs accept:
# 1, true, TRUE, yes, YES, on, ON, and 
# 0, false, FALSE, no, NO, off, OFF
inputs:
  # Shared (import + compile)
  api-key:
    description: "API key for authentication"
    required: true
  url:
    description: "URL of the DataStage server"
    required: true
  user:
    description: "Username for authentication"
    required: true

  # Target project selection (import + compile)
  project:
    description: "DataStage project name (required if project-id not set)"
    required: false
    default: ""
  project-id:
    description: "DataStage project id (required if project not set)"
    required: false
    default: ""

  # Assets + overlay
  assets:
    description: "Path to DataStage export zip file or directory (input assets)"
    required: true
  overlay:
    description: "Directory containing asset overlays"
    required: true
  properties:
    description: "Optional properties file with replacement values"
    required: false
    default: ""

  # Where to write overlaid assets (passed to overlay apply; then imported)
  overlay-output:
    description: "Zip file or directory to write updated assets (default: derived)"
    required: false
    default: ""
 
  # Compile report options
  report:
    description: "Path to output the compile report"
    required: false
    default: "compile-report.xml"
  include-asset-in-test-name:
    description: "Include asset names in test names in the report? (true/false)"
    required: false
    default: ""

outputs:
  # Not required in a composite action as we're responsible for both producing and consuming the file. 
  # However, we can still declare them here for documentation purposes and to allow referencing them in the 'value' field below.
  overlay-assets:
    description: "Path to the overlaid assets produced by overlay apply"
    value: ${{ steps.prep.outputs.overlay_assets }}
  import-junit-path:
    description: "Path to the JUnit report produced by import"
    value: ${{ steps.import.outputs.junit-path }}
  compile-junit-path:
    description: "Path to the JUnit report produced by compile"
    value: ${{ steps.compile.outputs.junit-path }}
  return-code:
    description: "Return code (0 if overlay, import, and compile commands succeeded, otherwise non-zero)"
    value: ${{ steps.compile.outputs.return-code }}
    # Any non-zero return code from a step BEFORE compile will cause the whole action to fail, so we'll never reach this point

runs:
  using: "composite"
  steps:
    - name: Prepare paths / defaults
      id: prep
      shell: bash
      run: |
        "${{ github.action_path }}/entrypoint.sh"
      env:
        # Overlay Apply parameters
        PARAM_ASSETS: ${{ inputs.assets }}
        PARAM_OVERLAY: ${{ inputs.overlay }}
        PARAM_PROPERTIES: ${{ inputs.properties }}
        PARAM_OVERLAY_OUTPUT: ${{ inputs.overlay-output }}
        # DataStage Import parameters
        PARAM_API_KEY: ${{ inputs.api-key }}
        PARAM_URL: ${{ inputs.url }}
        PARAM_USER: ${{ inputs.user }}
        # PARAM_ASSETS: ${{ inputs.assets }} (overlaid assets path is determined by overlay apply output)
        PARAM_PROJECT: ${{ inputs.project }}
        PARAM_PROJECT_ID: ${{ inputs.project-id }}
        # DataStage Compile parameters
        PARAM_REPORT: ${{ inputs.report }}
        PARAM_INCLUDE_ASSET_IN_TEST_NAME: ${{ inputs.include-asset-in-test-name }}

    - name: Apply overlays
      id: overlay
      uses: mettleci/mcix/overlay/apply@latest
      with:
        assets: ${{ inputs.assets }}
        output: ${{ steps.prep.outputs.overlay_assets }}
        overlay: ${{ inputs.overlay }}
        properties: ${{ inputs.properties }}

    - name: Import assets
      id: import
      uses: mettleci/mcix/datastage/import@latest
      with:
        api-key: ${{ inputs.api-key }}
        url: ${{ inputs.url }}
        user: ${{ inputs.user }}
        assets: ${{ steps.prep.outputs.overlay_assets }}
        project: ${{ inputs.project }}
        project-id: ${{ inputs.project-id }}

    - name: Compile project
      id: compile
      uses: mettleci/mcix/datastage/compile@latest
      with:
        api-key: ${{ inputs.api-key }}
        url: ${{ inputs.url }}
        user: ${{ inputs.user }}
        report: ${{ inputs.report }}
        project: ${{ inputs.project }}
        project-id: ${{ inputs.project-id }}
        include-asset-in-test-name: ${{ inputs.include-asset-in-test-name }}