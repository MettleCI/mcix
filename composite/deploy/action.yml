# action.yml

# ███╗   ███╗███████╗████████╗████████╗██╗     ███████╗ ██████╗██╗
# ████╗ ████║██╔════╝╚══██╔══╝╚══██╔══╝██║     ██╔════╝██╔════╝██║
# ██╔████╔██║█████╗     ██║      ██║   ██║     █████╗  ██║     ██║
# ██║╚██╔╝██║██╔══╝     ██║      ██║   ██║     ██╔══╝  ██║     ██║
# ██║ ╚═╝ ██║███████╗   ██║      ██║   ███████╗███████╗╚██████╗██║
# ╚═╝     ╚═╝╚══════╝   ╚═╝      ╚═╝   ╚══════╝╚══════╝ ╚═════╝╚═╝
# MettleCI DevOps for DataStage       (C) 2025-2026 Data Migrators
#                                      _ _
#   ___ ___  _ __ ___  _ __   ___  ___(_) |_ ___
#  / __/ _ \| '_ ` _ \| '_ \ / _ \/ __| | __/ _ \
# | (_| (_) | | | | | | |_) | (_) \__ \ | ||  __/
#  \___\___/|_| |_| |_| .__/ \___/|___/_|\__\___|
#      _            _ |_|
#   __| | ___ _ __ | | ___  _   _
#  / _` |/ _ \ '_ \| |/ _ \| | | |
# | (_| |  __/ |_) | | (_) | |_| |
#  \__,_|\___| .__/|_|\___/ \__, |
#            |_|            |___/

name: "MCIX deploy (overlay, import, compile)"
description: "Applies overlays to DataStage assets, then imports and compiles them"
author: "Data Migrators Pty Ltd"
branding:
  icon: "layers"
  color: "blue"

inputs:
  # Shared (import + compile)
  api-key:
    description: "API key for authentication"
    required: true
  url:
    description: "URL of the DataStage server"
    required: true
  user:
    description: "Username for authentication"
    required: true

  # Target project selection (import + compile)
  project:
    description: "DataStage project name (required if project-id not set)"
    required: false
    default: ""
  project-id:
    description: "DataStage project id (required if project not set)"
    required: false
    default: ""

  # Assets + overlay
  assets:
    description: "Path to DataStage export zip file or directory (input assets)"
    required: true
  overlays:
    description: |
      One or more overlay directories. Overlays are applied in the order specified.
      Provide as comma- or newline-separated list.
      Example:
        overlays: overlays/base, overlays/customer
        or
        overlays: |
          overlays/base
          overlays/customer
    required: true
  properties:
    description: "Optional properties file with replacement values"
    required: false
    default: ""

  # Where to write overlaid assets (passed to overlay apply; then imported)
  output:
    description: "Zip file or directory to write updated assets (default: derived)"
    required: false
    default: ""

  # Compile report options
  report:
    description: "Path to output the compile report"
    required: false
    default: "compile-report.xml"
  include-asset-in-test-name:
    description: "Include asset names in test names in the report? (true/false)"
    required: false
    default: ""

outputs:
  # This is the normalized output path from the prep step, which was passed to overlay/apply and then imported by the import step.
  overlay_output:
    description: "Path to the overlaid assets produced by overlay apply"
    value: ${{ steps.prep.outputs.output }}  
  import-junit-path:
    description: "Path to the JUnit report produced by import"
    value: ${{ steps.import.outputs.junit-path }}
  compile-junit-path:
    description: "Path to the JUnit report produced by compile"
    value: ${{ steps.compile.outputs.junit-path }}
  return-code:
    description: "Return code (0 if overlay, import, and compile commands succeeded, otherwise non-zero)"
    value: ${{ steps.compile.outputs.return-code }}

runs:
  using: "composite"
  steps:
    - name: Prepare paths / defaults
      id: prep
      shell: bash
      run: |
        "${{ github.action_path }}/entrypoint.sh"
      env:
        # Overlay Apply parameters
        PARAM_ASSETS: ${{ inputs.assets }}
        PARAM_OVERLAYS: ${{ inputs.overlays }}
        PARAM_PROPERTIES: ${{ inputs.properties }}
        PARAM_OUTPUT: ${{ inputs.output }}  # optional

        # DataStage Import parameters
        PARAM_API_KEY: ${{ inputs.api-key }}
        PARAM_URL: ${{ inputs.url }}
        PARAM_USER: ${{ inputs.user }}
        PARAM_PROJECT: ${{ inputs.project }}
        PARAM_PROJECT_ID: ${{ inputs.project-id }}

        # DataStage Compile parameters
        PARAM_REPORT: ${{ inputs.report }}
        PARAM_INCLUDE_ASSET_IN_TEST_NAME: ${{ inputs.include-asset-in-test-name }}

    - name: Apply overlays
      id: overlay
      uses: mettleci/mcix/overlay/apply@v1
      with:
        assets: ${{ steps.prep.outputs.assets }}
        overlays: ${{ steps.prep.outputs.overlays }}
        output: ${{ steps.prep.outputs.overlay_output }}
        properties: ${{ steps.prep.outputs.properties }}

    - name: Import assets
      id: import
      uses: mettleci/mcix/datastage/import@v1
      with:
        api-key: ${{ steps.prep.outputs.api_key }}
        url: ${{ steps.prep.outputs.url }}
        user: ${{ steps.prep.outputs.user }}
        project: ${{ steps.prep.outputs.project }}
        project-id: ${{ steps.prep.outputs.project_id }}
        assets: ${{ steps.prep.outputs.overlay_output }}  # output from overlay apply

    - name: Compile project
      id: compile
      uses: mettleci/mcix/datastage/compile@v1
      with:
        api-key: ${{ steps.prep.outputs.api_key }}
        url: ${{ steps.prep.outputs.url }}
        user: ${{ steps.prep.outputs.user }}
        report: ${{ steps.prep.outputs.report }}
        project: ${{ steps.prep.outputs.project }}
        project-id: ${{ steps.prep.outputs.project_id }}
        include-asset-in-test-name: ${{ steps.prep.outputs.compile_include_asset_in_test_name }}